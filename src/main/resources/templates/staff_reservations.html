<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('All Reservations (Staff) - StudyRooms')}">
    <title>All Reservations (Staff) - StudyRooms</title>
</head>

<body th:replace="~{layout :: body('', ~{::content})}">
<div th:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Reservations (Staff View)</h2>
        <a th:href="@{/staff/occupancy}" class="btn btn-outline-primary">Occupancy stats</a>
    </div>

    <!-- Flash message after close-space action -->
    <div th:if="${message}" class="alert alert-info" th:text="${message}"></div>

    <!-- Filter by date (single date, auto-submit on change) -->
    <form th:action="@{/staff/reservations}" method="get"
          class="row g-2 align-items-end mb-3">

        <div class="col-auto">
            <label for="date" class="form-label mb-0">Date</label>
            <input id="date" type="date" name="date"
                   th:value="${selectedDate}"
                   class="form-control"
                   onchange="this.form.submit()">
        </div>

        <div class="col-auto">
            <label class="form-label mb-0">&nbsp;</label>
            <!-- Clear → Today -->
            <a th:href="@{/staff/reservations}" class="btn btn-outline-secondary d-block">
                Today
            </a>
        </div>
    </form>

    <!-- Close space for a whole day (cancel all reservations) -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title mb-3">Close space for a day (cancel all reservations)</h5>

            <form th:action="@{/staff/close-space}" method="post" class="row g-2 align-items-end">
                       <input type="hidden"
                              th:if="${_csrf != null}"
                              th:name="${_csrf.parameterName}"
                              th:value="${_csrf.token}"/>

                <!-- στέλνουμε τη selectedDate ως hidden, αλλά ΔΕΝ πιάνει columns -->
                <input type="hidden" name="date" th:value="${selectedDate}"/>

                <!-- Space select -->
                <div class="col-md-6 col-lg-4">
                    <label for="spaceId" class="form-label mb-0">Space</label>
                    <select id="spaceId" name="spaceId" class="form-select" required>
                        <option value="" disabled selected>Select space</option>
                        <option th:each="s : ${spaces}"
                                th:value="${s.id}"
                                th:text="${s.name}">
                        </option>
                    </select>
                </div>

                <!-- Button δίπλα στο select -->
                <div class="col-md-6 col-lg-3">
                    <label class="form-label mb-0">&nbsp;</label>
                    <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('Close this space for the selected date and cancel all reservations?');">
                        Close space &amp; cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reservations table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>User</th>
                <th>Space</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th class="text-center" style="width: 180px;">Actions</th>
            </tr>
            </thead>

            <tbody>

            <tr th:each="r : ${reservations}">
                <td th:text="${r.user.username}">student</td>
                <td th:text="${r.studySpace.name}">Room A</td>
                <td th:text="${r.date}">2025-01-01</td>
                <td>
                    <span th:text="${r.startTime}">10:00</span>
                    -
                    <span th:text="${r.endTime}">12:00</span>
                </td>
                <td>
                    <span class="badge"
                          th:classappend="${r.status} == 'CONFIRMED' ? ' bg-success' :
                                          (${r.status} == 'PENDING' ? ' bg-warning text-dark' :
                                           (${r.status} == 'CANCELLED' ? ' bg-secondary' :
                                            (${r.status} == 'CANCELLED_BY_STAFF' ? ' bg-danger' : ' bg-light text-dark'))) "
                          th:text="${r.status}">
                        CONFIRMED
                    </span>
                </td>
                <td>
                    <form th:if="${r.status != T(gr.hua.dit.studyrooms.entity.ReservationStatus).CANCELLED
              and r.status != T(gr.hua.dit.studyrooms.entity.ReservationStatus).CANCELLED_BY_STAFF}"
                          th:action="@{/staff/reservations/{id}/cancel(id=${r.id})}"
                          method="post"
                          class="d-inline">

                        <!-- CSRF -->
                               <input type="hidden"
                                      th:if="${_csrf != null}"
                                      th:name="${_csrf.parameterName}"
                                      th:value="${_csrf.token}" />

                        <!-- Στέλνουμε την ημερομηνία φίλτρου πίσω στον controller -->
                        <input type="hidden" name="date"
                               th:value="${selectedDate}" />

                        <button type="submit"
                                class="btn btn-sm btn-danger"
                                onclick="return confirm('Cancel this reservation?');">
                            Cancel
                        </button>
                    </form>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(reservations)}">
                <td colspan="6" class="text-center text-muted">
                    No reservations found for the selected criteria.
                </td>
            </tr>

            </tbody>
        </table>
    </div>

    <a th:href="@{/dashboard}" class="btn btn-secondary mt-3">
        Back to Dashboard
    </a>

</div>
</body>
</html>
